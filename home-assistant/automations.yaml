# =========================================================
# SLEEP + BED CONTEXT
# =========================================================

- id: bed_occupancy_sets_in_bed
  alias: Bed Occupancy -> In Bed
  description: >
    If the bed pressure sensor turns on, mark the system as 'in bed'.
    This is a *signal* used by other automations; it does not directly
    control devices.
  trigger:
    - platform: state
      entity_id: binary_sensor.bed_pressure
      to: "on"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.in_bed

- id: bed_vacated_clears_in_bed
  alias: Bed Vacated -> Not In Bed
  trigger:
    - platform: state
      entity_id: binary_sensor.bed_pressure
      to: "off"
      for: "00:02:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.in_bed

- id: good_night_manual_button
  alias: Manual Good Night Button
  description: >
    Local test trigger (dashboard). Later you can keep this as a backup
    even when Garmin buttons are enabled.
  trigger:
    - platform: state
      entity_id: input_button.good_night_button
  action:
    - service: script.good_night

# =========================================================
# GARMIN WATCH BUTTONS (WEBHOOKS)
# =========================================================

- id: garmin_good_night
  alias: Garmin Button -> Good Night
  trigger:
    - platform: webhook
      webhook_id: garmin_good_night
  action:
    - service: script.good_night

- id: garmin_coffee
  alias: Garmin Button -> Coffee
  trigger:
    - platform: webhook
      webhook_id: garmin_coffee
  condition:
    # Prevent accidental coffee at midnight
    - condition: time
      after: "05:00:00"
      before: "10:30:00"
  action:
    - service: script.make_coffee

- id: garmin_cancel_all
  alias: Garmin Button -> Cancel / Reset Modes
  trigger:
    - platform: webhook
      webhook_id: garmin_cancel_all
  action:
    - service: input_boolean.turn_off
      target:
        entity_id:
          - input_boolean.sleep_mode
          - input_boolean.morning_mode
          - input_boolean.in_bed

# =========================================================
# MOTION LIGHTING (CONTEXT-AWARE)
# =========================================================

- id: motion_sets_room_occupied
  alias: Motion -> Room Occupied
  trigger:
    - platform: state
      entity_id: binary_sensor.room_motion
      to: "on"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.room_occupied

- id: no_motion_clears_room_occupied
  alias: No Motion -> Room Not Occupied
  trigger:
    - platform: state
      entity_id: binary_sensor.room_motion
      to: "off"
      for: "00:10:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.room_occupied

- id: motion_lighting_when_awake
  alias: Motion Lighting (Only When Not Asleep)
  description: >
    Turn on a gentle light when motion is detected,
    but never when Sleep Mode is on.
  trigger:
    - platform: state
      entity_id: binary_sensor.room_motion
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "off"
  action:
    - service: light.turn_on
      target:
        entity_id: light.bedroom
      data:
        brightness_pct: 30

- id: lights_off_after_no_motion
  alias: Lights Off After No Motion
  trigger:
    - platform: state
      entity_id: input_boolean.room_occupied
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.sleep_mode
      state: "off"
  action:
    - service: light.turn_off
      target:
        entity_id: light.bedroom

# =========================================================
# MORNING MODE
# =========================================================

- id: morning_mode_when_bed_vacated
  alias: Morning Mode When Bed Vacated
  description: >
    When leaving bed in the morning window, exit sleep mode and run
    the morning briefing routine.
  trigger:
    - platform: state
      entity_id: input_boolean.in_bed
      to: "off"
  condition:
    - condition: time
      after: "05:30:00"
      before: "09:30:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.sleep_mode
    - service: script.morning_briefing

